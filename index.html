<!doctype html>

<html lang="en">
  <body>
    <input type="file" accept="video/*" />
    <p id="progress1"></p>
    <p id="progress2"></p>
    <video id="video" style="display: none;"></video>
    <canvas id="canvas"></canvas>
    <button id="play">Replay</button>
    <div id="result"></div>

    <script type="text/javascript" src="compatibility.js"></script>
    <script type="text/javascript">
      // Should be higher than real FPS to not skip real frames
      // Hardcoded due to JS limitations
      var fps = 25;

      // Low rate decreases the chance of losing frames with poor browser performances
      var playbackRate = 0.5;

      var video = document.querySelector('#video');
      var canvas = document.querySelector('#canvas');
      var ctx = canvas.getContext('2d');
      var progress1 = document.querySelector('#progress1');
      var progress2 = document.querySelector('#progress2');
      var result = document.querySelector('#result');

      var frames = [];
      var lastFrame = -1;

      document.querySelector('input').addEventListener('change', extractFrames, false);
      document.querySelector('#play').addEventListener('click', replay, false);

      function extractFrames() {
        if (this.files.length == 0) {
          return;
        }

        frames = [];
        lastFrame = -1;
        result.innerHTML = '';
        var inflight = 0;

        function initCanvas(e) {
          video.removeEventListener('loadedmetadata', initCanvas);

          canvas.width = this.videoWidth;
          canvas.height = this.videoHeight;
          progress1.innerHTML = canvas.width + 'x' + canvas.height;

          compatibility.requestAnimationFrame(drawFrame);
        }

        function drawFrame() {
          if (video.ended) {
            if (frames.length == inflight) {
              ended();
            }
            return;
          }

          compatibility.requestAnimationFrame(drawFrame);

          if (video.readyState !== video.HAVE_CURRENT_DATA &&
              video.readyState !== video.HAVE_FUTURE_DATA &&
              video.readyState !== video.HAVE_ENOUGH_DATA) {
            return;
          }

          progress1.innerHTML = ((video.currentTime / video.duration) * 100).toFixed(2) + ' %';

          var currentFrame = Math.round(video.currentTime * fps);
          if (currentFrame != lastFrame) {
            lastFrame = currentFrame;
            inflight++;
            progress2.innerHTML = currentFrame + ' inflight = ' + inflight;

            ctx.drawImage(video, 0, 0);
            canvas.toBlob(saveFrame, 'image/jpeg');
          }
        }

        function saveFrame(blob) {
          img = new Image();
          img.onload = revokeURL;
          img.src = URL.createObjectURL(blob);
          frames.push(img);

          // canvas.toBlob() is asyncronous and might take a while to complete
          if (video.ended && frames.length == inflight) {
            ended();
          }
        }

        function ended() {
          console.log('video: ' + video.ended + ', ' + frames.length + ' vs ' + inflight);
          progress1.innerHTML = 'Completed with ' + frames.length + ' frames captured. inflight = ' + inflight;
          progress2.innerHTML = '';
          URL.revokeObjectURL(video.src);
        }

        function revokeURL(e) {
          URL.revokeObjectURL(this.src);
        }

        video.autoplay = false;
        video.muted = true;
        video.loop = false;
        video.addEventListener('loadedmetadata', initCanvas, false);
        video.src = URL.createObjectURL(this.files[0]);
        video.playbackRate = playbackRate;
        video.play();
      }

      function replay() {
        lastFrame = 0;
        nextFrame();
      }

      function nextFrame() {
        if (lastFrame < 0 || lastFrame >= frames.length) {
          return;
        }

        console.log(lastFrame + ': ' + frames[lastFrame] + ' - length: ' + frames.length);
        ctx.drawImage(frames[lastFrame], 0, 0);
        lastFrame++;
        setTimeout(nextFrame, 1000 / fps);
      }
    </script>
  </body>
</html>
